<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecionar Paciente - Sistema CAA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Selecione o Paciente
            </h1>
            <div class="header-actions">
                <span id="usuarioNome" style="color: var(--gray-500); margin-right: 12px;"></span>
                <a href="/historico" class="btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Hist√≥rico
                </a>
                <a href="/gerenciar" class="btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Gerenciar
                </a>
                <button onclick="logout()" class="btn-danger">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Sair
                </button>
            </div>
        </header>

        <div class="pacientes-section">
            <div class="pacientes-header">
                <h2>Seus Pacientes</h2>
                <button onclick="mostrarFormularioNovoPaciente()" class="btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Novo Paciente
                </button>
            </div>

            <!-- Formul√°rio para novo paciente -->
            <div id="formNovoPaciente" class="form-novo-paciente" style="display: none;">
                <h3>Cadastrar Novo Paciente</h3>
                <form id="formCadastro">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome">Nome do Paciente *</label>
                            <input type="text" id="nome" required placeholder="Nome completo">
                        </div>
                        
                        <div class="form-group">
                            <label for="dataNascimento">Data de Nascimento</label>
                            <input type="date" id="dataNascimento">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="nivelSuporte">N√≠vel de Suporte</label>
                        <select id="nivelSuporte">
                            <option value="">Selecione...</option>
                            <option value="N√≠vel 1">N√≠vel 1 - Requer suporte</option>
                            <option value="N√≠vel 2">N√≠vel 2 - Requer suporte substancial</option>
                            <option value="N√≠vel 3">N√≠vel 3 - Requer suporte muito substancial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="diagnostico">Diagn√≥stico / Observa√ß√µes</label>
                        <textarea id="diagnostico" rows="3" placeholder="Informa√ß√µes adicionais sobre o paciente"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Salvar
                        </button>
                        <button type="button" onclick="esconderFormularioNovoPaciente()" class="btn-secondary">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de pacientes -->
            <div id="listaPacientes" class="pacientes-grid">
                <div class="loading">Carregando pacientes...</div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modals.js') }}"></script>
    <script>
        let pacientes = [];

        // Carregar dados ao abrir a p√°gina
        window.addEventListener('DOMContentLoaded', async () => {
            await carregarUsuarioAtual();
            await carregarPacientes();
        });

        async function carregarUsuarioAtual() {
            try {
                const response = await fetch('/api/usuario/atual');
                const data = await response.json();
                
                if (!data.logado) {
                    window.location.href = '/';
                    return;
                }
                
                document.getElementById('usuarioNome').textContent = `Ol√°, ${data.usuario.nome}`;
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        async function carregarPacientes() {
            try {
                const response = await fetch('/api/pacientes');
                const data = await response.json();
                
                if (data.erro === 'N√£o autenticado') {
                    window.location.href = '/';
                    return;
                }
                
                pacientes = data.pacientes || [];
                renderizarPacientes();
            } catch (error) {
                console.error('Erro ao carregar pacientes:', error);
                document.getElementById('listaPacientes').innerHTML = 
                    '<p class="error">Erro ao carregar pacientes.</p>';
            }
        }

        function renderizarPacientes() {
            const lista = document.getElementById('listaPacientes');
            
            if (pacientes.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <line x1="17" y1="11" x2="23" y2="11"/>
                        </svg>
                        <p>Nenhum paciente cadastrado ainda</p>
                        <button onclick="mostrarFormularioNovoPaciente()" class="btn-primary">
                            Cadastrar Primeiro Paciente
                        </button>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = pacientes.map(p => `
                <div class="paciente-card" onclick="selecionarPaciente(${p.id})">
                    <div class="paciente-avatar">
                        ${p.foto_perfil ? 
                            `<img src="${p.foto_perfil}" alt="${p.nome}">` : 
                            '<span class="avatar-placeholder">üë§</span>'
                        }
                    </div>
                    <div class="paciente-info">
                        <h3>${p.nome}</h3>
                        ${p.nivel_suporte ? `<span class="nivel-suporte">${p.nivel_suporte}</span>` : ''}
                        ${p.data_nascimento ? `<p>Nascimento: ${formatarData(p.data_nascimento)}</p>` : ''}
                    </div>
                    <div class="paciente-action">
                        <span class="btn-select">Selecionar ‚Üí</span>
                    </div>
                </div>
            `).join('');
        }

        function selecionarPaciente(pacienteId) {
            window.location.href = `/comunicacao/${pacienteId}`;
        }

        function mostrarFormularioNovoPaciente() {
            document.getElementById('formNovoPaciente').style.display = 'block';
            document.getElementById('nome').focus();
        }

        function esconderFormularioNovoPaciente() {
            document.getElementById('formNovoPaciente').style.display = 'none';
            document.getElementById('formCadastro').reset();
        }

        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dados = {
                nome: document.getElementById('nome').value,
                data_nascimento: document.getElementById('dataNascimento').value || null,
                nivel_suporte: document.getElementById('nivelSuporte').value || null,
                diagnostico: document.getElementById('diagnostico').value || null
            };
            
            try {
                const response = await fetch('/api/pacientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();

                if (result.sucesso) {
                    showAlert('Paciente cadastrado com sucesso!', 'success');
                    esconderFormularioNovoPaciente();
                    carregarPacientes();
                } else {
                    showAlert('Erro ao cadastrar: ' + (result.erro || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao cadastrar paciente', 'error');
            }
        });

        async function logout() {
            const confirmar = await showConfirm('Deseja realmente sair?');
            if (confirmar) {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            }
        }

        function formatarData(dataISO) {
            const data = new Date(dataISO + 'T00:00:00');
            return data.toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>
