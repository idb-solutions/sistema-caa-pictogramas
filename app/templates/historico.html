<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico de Sess√µes - Sistema CAA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Hist√≥rico de Sess√µes
            </h1>
            <div class="header-actions">
                <span id="usuarioNome" style="color: var(--gray-500); margin-right: 12px;"></span>
                <a href="/selecionar-paciente" class="btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    Pacientes
                </a>
                <a href="/gerenciar" class="btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Gerenciar
                </a>
                <button onclick="logout()" class="btn-danger">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Sair
                </button>
            </div>
        </header>

        <!-- Filtros -->
        <div class="pacientes-section" style="margin-bottom: 24px;">
            <div class="pacientes-header">
                <h2>Filtros</h2>
                <button onclick="limparFiltros()" class="btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"/>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                    Limpar
                </button>
            </div>
            <form id="formFiltros">
                <div class="form-row">
                    <div class="form-group">
                        <label for="filtroPaciente">Paciente</label>
                        <select id="filtroPaciente">
                            <option value="">Todos os pacientes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroPeriodoInicio">Data In√≠cio</label>
                        <input type="date" id="filtroPeriodoInicio">
                    </div>
                    <div class="form-group">
                        <label for="filtroPeriodoFim">Data Fim</label>
                        <input type="date" id="filtroPeriodoFim">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn-primary" style="width: 100%;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Lista de Sess√µes -->
        <div class="pacientes-section">
            <div class="pacientes-header">
                <h2>Sess√µes Registradas</h2>
                <div>
                    <span id="totalSessoes" style="color: var(--gray-500); font-size: 0.9rem; margin-right: 16px;"></span>
                </div>
            </div>

            <div id="listaSessoes">
                <div class="loading">Carregando hist√≥rico...</div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Sess√£o -->
    <div id="modalDetalhes" class="modal-overlay" style="display: none;" onclick="fecharModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px;">
            <h2>Detalhes da Sess√£o</h2>

            <div id="detalhesHeader" style="background: var(--gray-50); padding: 16px; border-radius: var(--radius); margin-bottom: 20px;">
                <!-- Info da sess√£o ser√° inserida aqui -->
            </div>

            <div id="detalhesHistorico">
                <h3 style="margin-bottom: 12px; color: var(--gray-700);">Pictogramas Selecionados</h3>
                <div id="listaHistorico" style="max-height: 400px; overflow-y: auto;">
                    <!-- Timeline ser√° inserida aqui -->
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="fecharModal()" class="btn-secondary" style="flex: none;">Fechar</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modals.js') }}"></script>
    <script>
        let sessoes = [];
        let sessoesOriginal = [];
        let pacientes = [];

        // Carregar dados ao abrir a p√°gina
        window.addEventListener('DOMContentLoaded', async () => {
            await carregarUsuarioAtual();
            await carregarPacientes();
            await carregarSessoes();
        });

        async function carregarUsuarioAtual() {
            try {
                const response = await fetch('/api/usuario/atual');
                const data = await response.json();

                if (!data.logado) {
                    window.location.href = '/';
                    return;
                }

                document.getElementById('usuarioNome').textContent = `Ol√°, ${data.usuario.nome}`;
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        async function carregarPacientes() {
            try {
                const response = await fetch('/api/pacientes');
                const data = await response.json();

                if (data.erro === 'N√£o autenticado') {
                    window.location.href = '/';
                    return;
                }

                pacientes = data.pacientes || [];

                // Popular select de filtro
                const select = document.getElementById('filtroPaciente');
                pacientes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar pacientes:', error);
            }
        }

        async function carregarSessoes() {
            try {
                const response = await fetch('/api/sessoes');
                const data = await response.json();

                if (data.erro === 'N√£o autenticado') {
                    window.location.href = '/';
                    return;
                }

                sessoesOriginal = data.sessoes || [];
                sessoes = [...sessoesOriginal];
                renderizarSessoes();
            } catch (error) {
                console.error('Erro ao carregar sess√µes:', error);
                document.getElementById('listaSessoes').innerHTML =
                    '<p class="error">Erro ao carregar hist√≥rico.</p>';
            }
        }

        function renderizarSessoes() {
            const lista = document.getElementById('listaSessoes');
            const totalEl = document.getElementById('totalSessoes');

            totalEl.textContent = `${sessoes.length} sess√£o${sessoes.length !== 1 ? '√µes' : ''} encontrada${sessoes.length !== 1 ? 's' : ''}`;

            if (sessoes.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <p>Nenhuma sess√£o encontrada</p>
                    </div>
                `;
                return;
            }

            // Renderizar como tabela
            lista.innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="historico-table">
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Profissional</th>
                                <th>Data/Hora</th>
                                <th>Dura√ß√£o</th>
                                <th>Status</th>
                                <th>Intera√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessoes.map(s => renderizarLinhaSessao(s)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderizarLinhaSessao(sessao) {
            const statusBadge = sessao.finalizada
                ? '<span class="badge badge-success">Finalizada</span>'
                : '<span class="badge badge-warning">Em andamento</span>';

            let duracao = '-';
            if (sessao.finalizada && sessao.duracao !== null) {
                duracao = formatarDuracao(sessao.duracao);
            } else if (sessao.finalizada) {
                duracao = 'N/A';
            }

            return `
                <tr style="cursor: pointer;" onclick="verDetalhes(${sessao.id})">
                    <td><strong>${sessao.paciente_nome || 'N/A'}</strong></td>
                    <td>${sessao.profissional_nome || 'N/A'}</td>
                    <td>${formatarDataHora(sessao.data_inicio)}</td>
                    <td>${duracao}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align: center;">${sessao.total_interacoes || 0}</td>
                    <td>
                        <button onclick="event.stopPropagation(); verDetalhes(${sessao.id})" class="btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">
                            Ver detalhes
                        </button>
                    </td>
                </tr>
            `;
        }

        async function verDetalhes(sessaoId) {
            try {
                // Buscar detalhes da sess√£o
                const response = await fetch(`/api/sessoes/${sessaoId}/historico`);

                if (!response.ok) {
                    showAlert('Erro ao carregar detalhes da sess√£o', 'error');
                    return;
                }

                const data = await response.json();
                const sessao = sessoes.find(s => s.id === sessaoId);

                // Renderizar header
                document.getElementById('detalhesHeader').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div>
                            <strong style="color: var(--gray-500); font-size: 0.8rem;">PACIENTE</strong>
                            <p style="font-size: 1.1rem; font-weight: 600; margin-top: 4px;">${sessao.paciente_nome}</p>
                        </div>
                        <div>
                            <strong style="color: var(--gray-500); font-size: 0.8rem;">PROFISSIONAL</strong>
                            <p style="font-size: 1.1rem; font-weight: 600; margin-top: 4px;">${sessao.profissional_nome}</p>
                        </div>
                        <div>
                            <strong style="color: var(--gray-500); font-size: 0.8rem;">DATA/HORA</strong>
                            <p style="margin-top: 4px;">${formatarDataHora(sessao.data_inicio)}</p>
                        </div>
                        <div>
                            <strong style="color: var(--gray-500); font-size: 0.8rem;">DURA√á√ÉO</strong>
                            <p style="margin-top: 4px;">${
                                sessao.finalizada
                                    ? (sessao.duracao !== null ? formatarDuracao(sessao.duracao) : 'Dura√ß√£o n√£o calculada')
                                    : '<span style="color: var(--warning);">Sess√£o em andamento</span>'
                            }</p>
                        </div>
                        ${sessao.avaliacao ? `
                        <div style="grid-column: 1 / -1; margin-top: 8px; padding: 14px; background: #F9FAFB; border-left: 4px solid #6B7280; border-radius: 6px;">
                            <strong style="color: #374151; font-size: 0.85rem; display: block; margin-bottom: 8px;">üìù AVALIA√á√ÉO DO PROFISSIONAL</strong>
                            <p style="margin: 0; line-height: 1.6; color: #1F2937;">${sessao.avaliacao}</p>
                        </div>
                        ` : ''}
                    </div>
                `;

                // Renderizar hist√≥rico de pictogramas
                const historico = data.historico || [];

                if (historico.length === 0) {
                    document.getElementById('listaHistorico').innerHTML = '<p style="color: var(--gray-400); text-align: center; padding: 20px;">Nenhum pictograma selecionado nesta sess√£o</p>';
                } else {
                    document.getElementById('listaHistorico').innerHTML = historico.map((item, index) => `
                        <div class="historico-item" style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                            <div style="width: 36px; height: 36px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; color: var(--primary-dark);">
                                ${index + 1}
                            </div>
                            <div style="flex: 1;">
                                <strong style="font-size: 1rem;">${item.pictograma_nome}</strong>
                                <p style="font-size: 0.8rem; color: var(--gray-500); margin-top: 2px;">Categoria: ${item.categoria_nome || 'N/A'}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Mostrar modal
                document.getElementById('modalDetalhes').style.display = 'flex';
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar detalhes', 'error');
            }
        }

        function fecharModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('modalDetalhes').style.display = 'none';
            }
        }

        document.getElementById('formFiltros').addEventListener('submit', (e) => {
            e.preventDefault();
            aplicarFiltros();
        });

        function aplicarFiltros() {
            const pacienteId = document.getElementById('filtroPaciente').value;
            const dataInicio = document.getElementById('filtroPeriodoInicio').value;
            const dataFim = document.getElementById('filtroPeriodoFim').value;

            sessoes = sessoesOriginal.filter(s => {
                // Filtro por paciente
                if (pacienteId && s.paciente_id != pacienteId) {
                    return false;
                }

                // Filtro por data
                const dataSessao = new Date(s.data_inicio);

                if (dataInicio) {
                    const dataInicioObj = new Date(dataInicio + 'T00:00:00');
                    if (dataSessao < dataInicioObj) return false;
                }

                if (dataFim) {
                    const dataFimObj = new Date(dataFim + 'T23:59:59');
                    if (dataSessao > dataFimObj) return false;
                }

                return true;
            });

            renderizarSessoes();
        }

        function limparFiltros() {
            document.getElementById('formFiltros').reset();
            sessoes = [...sessoesOriginal];
            renderizarSessoes();
        }

        async function logout() {
            const confirmar = await showConfirm('Deseja realmente sair?');
            if (confirmar) {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            }
        }

        function formatarDataHora(dataISO) {
            if (!dataISO) return 'Data n√£o dispon√≠vel';

            try {
                // Corrigir formato de data do SQLite (substituir espa√ßo por T para ISO)
                const dataCorrigida = dataISO.replace(' ', 'T');
                const data = new Date(dataCorrigida);

                // Verificar se data √© v√°lida
                if (isNaN(data.getTime())) {
                    return 'Data inv√°lida';
                }

                const dataStr = data.toLocaleDateString('pt-BR');
                const horaStr = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                return `${dataStr} √†s ${horaStr}`;
            } catch (error) {
                console.error('Erro ao formatar data:', error, dataISO);
                return 'Data inv√°lida';
            }
        }

        function formatarDuracao(segundos) {
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            const segs = segundos % 60;

            if (horas > 0) {
                return `${horas}h ${minutos}min`;
            } else if (minutos > 0) {
                return `${minutos}min ${segs}s`;
            } else {
                return `${segs}s`;
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                fecharModal();
            }
        });
    </script>
</body>
</html>
