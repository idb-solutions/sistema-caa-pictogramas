<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunica√ß√£o - {{ paciente.nome }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="comunicacao-container">
        <!-- Header -->
        <header class="header-comunicacao">
            <div class="header-left">
                <button onclick="voltarParaPacientes()" class="btn-back">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"/>
                        <polyline points="12 19 5 12 12 5"/>
                    </svg>
                    Voltar
                </button>
                <div class="paciente-info-header">
                    <h2>{{ paciente.nome }}</h2>
                    <p class="tempo-sessao">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span id="timer">00:00</span>
                    </p>
                </div>
            </div>
            <div class="header-right">
                <button onclick="toggleVoz()" id="btnVoz" class="btn-voice active">
                    üîä Voz Ativada
                </button>
                <button onclick="abrirModalFinalizar()" class="btn-finalizar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                    </svg>
                    Finalizar Sess√£o
                </button>
            </div>
        </header>

        <!-- Categorias -->
        <div class="categorias-tabs" id="categoriasTabs">
            <!-- Carregado via JavaScript -->
        </div>

        <!-- Pictogramas -->
        <div class="pictogramas-area" id="pictogramasArea">
            <div class="loading">Carregando pictogramas...</div>
        </div>
    </div>

    <!-- Modal de Finaliza√ß√£o -->
    <div id="modalFinalizar" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h2>Finalizar Sess√£o</h2>
            <p style="color: var(--gray-500); margin-bottom: 20px;">
                Por favor, fa√ßa uma avalia√ß√£o desta sess√£o antes de finalizar.
            </p>
            
            <form id="formFinalizar">
                <div class="form-group">
                    <label for="avaliacao">Avalia√ß√£o da Sess√£o *</label>
                    <textarea id="avaliacao" rows="4" required 
                              placeholder="Descreva como foi a sess√£o, comportamento do paciente, progressos observados, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes Adicionais</label>
                    <textarea id="observacoes" rows="2" 
                              placeholder="Observa√ß√µes opcionais"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Confirmar e Finalizar
                    </button>
                    <button type="button" onclick="fecharModalFinalizar()" class="btn-secondary">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modals.js') }}"></script>
    <script>
        const PACIENTE_ID = {{ paciente.id }};
        let sessaoId = null;
        let categorias = [];
        let pictogramas = [];
        let categoriaAtual = null;
        let vozAtivada = true;
        let tempoInicio = null;
        let timerInterval = null;

        // Inicializar ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', async () => {
            await iniciarSessao();
            await carregarCategorias();
            iniciarTimer();
        });

        async function iniciarSessao() {
            try {
                const response = await fetch('/api/sessoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paciente_id: PACIENTE_ID })
                });
                const data = await response.json();
                sessaoId = data.sessao_id;
                tempoInicio = Date.now();
            } catch (error) {
                console.error('Erro ao iniciar sess√£o:', error);
            }
        }

        async function carregarCategorias() {
            try {
                const response = await fetch('/api/categorias');
                const data = await response.json();
                categorias = data.categorias;
                
                renderizarCategorias();
                
                if (categorias.length > 0) {
                    selecionarCategoria(categorias[0].id);
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        function renderizarCategorias() {
            const tabs = document.getElementById('categoriasTabs');
            tabs.innerHTML = categorias.map(cat => `
                <button class="categoria-tab" 
                        style="background-color: ${cat.cor}"
                        onclick="selecionarCategoria(${cat.id})"
                        data-categoria-id="${cat.id}">
                    <span class="categoria-icone">${cat.icone}</span>
                    <span class="categoria-nome">${cat.nome}</span>
                </button>
            `).join('');
        }

        async function selecionarCategoria(categoriaId) {
            categoriaAtual = categoriaId;
            
            document.querySelectorAll('.categoria-tab').forEach(tab => {
                tab.classList.remove('active');
                if (parseInt(tab.dataset.categoriaId) === categoriaId) {
                    tab.classList.add('active');
                }
            });
            
            await carregarPictogramas(categoriaId);
        }

        async function carregarPictogramas(categoriaId) {
            try {
                const response = await fetch(`/api/pictogramas?categoria_id=${categoriaId}`);
                const data = await response.json();
                pictogramas = data.pictogramas;
                
                renderizarPictogramas();
            } catch (error) {
                console.error('Erro ao carregar pictogramas:', error);
            }
        }

        function renderizarPictogramas() {
            const area = document.getElementById('pictogramasArea');
            
            if (pictogramas.length === 0) {
                area.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 40px;">Nenhum pictograma nesta categoria</p>';
                return;
            }
            
            area.innerHTML = pictogramas.map(pict => `
                <div class="pictograma-card" onclick="clicarPictograma(event, ${pict.id}, '${pict.nome}', '${pict.audio_texto}')">
                    <div class="pictograma-imagem">
                        <img src="${pict.imagem_url}" alt="${pict.nome}" 
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size:3rem\\'>üì∑</span>'">
                    </div>
                    <div class="pictograma-nome">${pict.nome}</div>
                </div>
            `).join('');
        }

        async function clicarPictograma(event, pictogramaId, nome, audioTexto) {
            const tempoClique = Date.now();
            const tempoResposta = (tempoClique - tempoInicio) / 1000;

            // Feedback visual
            const card = event?.currentTarget || event?.target?.closest('.pictograma-card');
            if (card) {
                card.classList.add('clicked');
                setTimeout(() => {
                    card.classList.remove('clicked');
                }, 300);
            }

            // Fala o texto (se voz ativada) - precisa ser ap√≥s intera√ß√£o do usu√°rio
            if (vozAtivada) {
                console.log('Tentando falar:', audioTexto);
                try {
                    falar(audioTexto);
                } catch (error) {
                    console.error('Erro ao reproduzir √°udio:', error);
                    showAlert('Erro ao reproduzir √°udio: ' + error.message, 'error');
                }
            } else {
                console.log('Voz desativada - n√£o falando');
            }

            // Registra no banco
            try {
                await fetch(`/api/sessoes/${sessaoId}/selecao`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pictograma_id: pictogramaId,
                        tempo_resposta_segundos: tempoResposta
                    })
                });
            } catch (error) {
                console.error('Erro ao registrar sele√ß√£o:', error);
            }
        }

        function falar(texto) {
            if (!texto) {
                console.warn('Texto vazio, n√£o h√° o que falar');
                return;
            }

            try {
                // For√ßa o cancelamento completo
                window.speechSynthesis.cancel();

                // Aguarda um momento para garantir que cancelou
                setTimeout(() => {
                    try {
                        const utterance = new SpeechSynthesisUtterance(texto);
                        utterance.lang = 'pt-BR';
                        utterance.rate = 0.9;
                        utterance.pitch = 1.1;
                        utterance.volume = 1.0;

                        utterance.onstart = () => {
                            console.log('Iniciou fala:', texto);
                        };

                        utterance.onend = () => {
                            console.log('Finalizou fala:', texto);
                        };

                        utterance.onerror = (event) => {
                            console.error('Erro na s√≠ntese de voz:', event);
                            // Tenta reinicializar em caso de erro
                            window.speechSynthesis.cancel();
                        };

                        // Verifica se o navegador est√° pronto
                        if (window.speechSynthesis.speaking) {
                            console.warn('Ainda falando, for√ßando parada...');
                            window.speechSynthesis.cancel();
                            setTimeout(() => window.speechSynthesis.speak(utterance), 200);
                        } else {
                            window.speechSynthesis.speak(utterance);
                        }
                    } catch (innerError) {
                        console.error('Erro interno ao falar:', innerError);
                    }
                }, 150);
            } catch (error) {
                console.error('Erro ao inicializar s√≠ntese de voz:', error);
            }
        }

        // Inicializar o sintetizador de voz quando a p√°gina carregar
        // Isso ajuda em alguns navegadores
        (function inicializarVoz() {
            try {
                // For√ßa o carregamento das vozes
                const voices = window.speechSynthesis.getVoices();
                console.log('Vozes dispon√≠veis:', voices.length);

                // Alguns navegadores precisam de um evento extra
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        const voicesUpdated = window.speechSynthesis.getVoices();
                        console.log('Vozes atualizadas:', voicesUpdated.length);
                    };
                }
            } catch (error) {
                console.error('Erro ao inicializar vozes:', error);
            }
        })();

        function toggleVoz() {
            vozAtivada = !vozAtivada;
            const btn = document.getElementById('btnVoz');
            btn.textContent = vozAtivada ? 'üîä Voz Ativada' : 'üîá Voz Desativada';
            btn.classList.toggle('active');

            // Reiniciar s√≠ntese ao ativar/desativar
            window.speechSynthesis.cancel();
        }

        // Sistema de prote√ß√£o contra travamento de √°udio
        // Verifica a cada 5 segundos se h√° fala presa e limpa
        setInterval(() => {
            if (window.speechSynthesis.speaking) {
                console.log('Verifica√ß√£o: S√≠ntese de voz ainda ativa');
            }
        }, 5000);

        function iniciarTimer() {
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const segundos = Math.floor((Date.now() - tempoInicio) / 1000);
                const mins = Math.floor(segundos / 60);
                const segs = segundos % 60;
                timerEl.textContent = `${String(mins).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
            }, 1000);
        }

        function abrirModalFinalizar() {
            document.getElementById('modalFinalizar').style.display = 'flex';
            document.getElementById('avaliacao').focus();
        }

        function fecharModalFinalizar() {
            document.getElementById('modalFinalizar').style.display = 'none';
        }

        document.getElementById('formFinalizar').addEventListener('submit', async (e) => {
            e.preventDefault();

            const avaliacao = document.getElementById('avaliacao').value.trim();
            const observacoes = document.getElementById('observacoes').value.trim();

            if (!avaliacao) {
                showAlert('A avalia√ß√£o √© obrigat√≥ria!', 'warning');
                return;
            }

            clearInterval(timerInterval);

            try {
                const response = await fetch(`/api/sessoes/${sessaoId}/finalizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ avaliacao, observacoes })
                });

                const data = await response.json();

                if (data.sucesso) {
                    showAlert(`Sess√£o finalizada com sucesso!\nDura√ß√£o: ${data.duracao_minutos} minuto(s)`, 'success');
                    setTimeout(() => {
                        window.location.href = '/selecionar-paciente';
                    }, 1500);
                } else {
                    showAlert('Erro: ' + (data.erro || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao finalizar sess√£o:', error);
                showAlert('Erro ao finalizar sess√£o', 'error');
            }
        });

        async function voltarParaPacientes() {
            const confirmar = await showConfirm('Deseja sair? Voc√™ precisar√° finalizar a sess√£o com uma avalia√ß√£o.');
            if (confirmar) {
                abrirModalFinalizar();
            }
        }
    </script>
</body>
</html>
